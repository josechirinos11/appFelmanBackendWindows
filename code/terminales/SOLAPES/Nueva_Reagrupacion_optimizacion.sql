'sp_fpresupuestosoptimizacion_exacto', 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION', 'CREATE DEFINER=`consultas`@`%` PROCEDURE `sp_fpresupuestosoptimizacion_exacto`(\n    IN p_Serie VARCHAR(50),\n    IN p_Numero INT,\n    IN p_CodigoArticulo VARCHAR(50),\n    IN p_CodigoAcabado VARCHAR(50),\n    IN p_CodigoAcabado2 VARCHAR(50)\n)\nBEGIN\n    -- Variables para optimización\n    SET @barra_actual = 1;\n    SET @longitud_acumulada = 0;\n    SET @items_en_barra = 0;\n    SET @barra_anterior = 1;\n    SET @row_number = 0;\n    \n    -- PASO 1: Crear tabla temporal con ítems individuales descompuestos\n    DROP TEMPORARY TABLE IF EXISTS temp_items_descompuestos;\n    CREATE TEMPORARY TABLE temp_items_descompuestos AS\n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 0\n        Med0 AS Med, MedH0 AS MedH, Modulo0 AS Modulo,\n        CASILLERO0 AS CASILLERO, CASILLEROB0 AS CASILLEROB,\n        Corte1_0 AS Corte1, Corte2_0 AS Corte2, Corte1b_0 AS Corte1b, Corte2b_0 AS Corte2b,\n        ID0 AS ID, KTN0 AS KTN, MAQ0 AS MAQ, MAQ2_0 AS MAQ2, REF0 AS REF,\n        Lin0 AS Lin, Sit0 AS Sit, Rec0 AS Rec, UD0 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med0 IS NOT NULL AND Med0 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 1\n        Med1 AS Med, MedH1 AS MedH, Modulo1 AS Modulo,\n        CASILLERO1 AS CASILLERO, CASILLEROB1 AS CASILLEROB,\n        Corte1_1 AS Corte1, Corte2_1 AS Corte2, Corte1b_1 AS Corte1b, Corte2b_1 AS Corte2b,\n        ID1 AS ID, KTN1 AS KTN, MAQ1 AS MAQ, MAQ2_1 AS MAQ2, REF1 AS REF,\n        Lin1 AS Lin, Sit1 AS Sit, Rec1 AS Rec, UD1 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med1 IS NOT NULL AND Med1 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 2\n        Med2 AS Med, MedH2 AS MedH, Modulo2 AS Modulo,\n        CASILLERO2 AS CASILLERO, CASILLEROB2 AS CASILLEROB,\n        Corte1_2 AS Corte1, Corte2_2 AS Corte2, Corte1b_2 AS Corte1b, Corte2b_2 AS Corte2b,\n        ID2 AS ID, KTN2 AS KTN, MAQ2 AS MAQ, MAQ2_2 AS MAQ2, REF2 AS REF,\n        Lin2 AS Lin, Sit2 AS Sit, Rec2 AS Rec, UD2 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med2 IS NOT NULL AND Med2 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 3\n        Med3 AS Med, MedH3 AS MedH, Modulo3 AS Modulo,\n        CASILLERO3 AS CASILLERO, CASILLEROB3 AS CASILLEROB,\n        Corte1_3 AS Corte1, Corte2_3 AS Corte2, Corte1b_3 AS Corte1b, Corte2b_3 AS Corte2b,\n        ID3 AS ID, KTN3 AS KTN, MAQ3 AS MAQ, MAQ2_3 AS MAQ2, REF3 AS REF,\n        Lin3 AS Lin, Sit3 AS Sit, Rec3 AS Rec, UD3 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med3 IS NOT NULL AND Med3 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 4\n        Med4 AS Med, MedH4 AS MedH, Modulo4 AS Modulo,\n        CASILLERO4 AS CASILLERO, CASILLEROB4 AS CASILLEROB,\n        Corte1_4 AS Corte1, Corte2_4 AS Corte2, Corte1b_4 AS Corte1b, Corte2b_4 AS Corte2b,\n        ID4 AS ID, KTN4 AS KTN, MAQ4 AS MAQ, MAQ2_4 AS MAQ2, REF4 AS REF,\n        Lin4 AS Lin, Sit4 AS Sit, Rec4 AS Rec, UD4 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med4 IS NOT NULL AND Med4 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 5\n        Med5 AS Med, MedH5 AS MedH, Modulo5 AS Modulo,\n        CASILLERO5 AS CASILLERO, CASILLEROB5 AS CASILLEROB,\n        Corte1_5 AS Corte1, Corte2_5 AS Corte2, Corte1b_5 AS Corte1b, Corte2b_5 AS Corte2b,\n        ID5 AS ID, KTN5 AS KTN, MAQ5 AS MAQ, MAQ2_5 AS MAQ2, REF5 AS REF,\n        Lin5 AS Lin, Sit5 AS Sit, Rec5 AS Rec, UD5 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med5 IS NOT NULL AND Med5 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 6\n        Med6 AS Med, MedH6 AS MedH, Modulo6 AS Modulo,\n        CASILLERO6 AS CASILLERO, CASILLEROB6 AS CASILLEROB,\n        Corte1_6 AS Corte1, Corte2_6 AS Corte2, Corte1b_6 AS Corte1b, Corte2b_6 AS Corte2b,\n        ID6 AS ID, KTN6 AS KTN, MAQ6 AS MAQ, MAQ2_6 AS MAQ2, REF6 AS REF,\n        Lin6 AS Lin, Sit6 AS Sit, Rec6 AS Rec, UD6 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med6 IS NOT NULL AND Med6 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 7\n        Med7 AS Med, MedH7 AS MedH, Modulo7 AS Modulo,\n        CASILLERO7 AS CASILLERO, CASILLEROB7 AS CASILLEROB,\n        Corte1_7 AS Corte1, Corte2_7 AS Corte2, Corte1b_7 AS Corte1b, Corte2b_7 AS Corte2b,\n        ID7 AS ID, KTN7 AS KTN, MAQ7 AS MAQ, MAQ2_7 AS MAQ2, REF7 AS REF,\n        Lin7 AS Lin, Sit7 AS Sit, Rec7 AS Rec, UD7 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med7 IS NOT NULL AND Med7 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 8\n        Med8 AS Med, MedH8 AS MedH, Modulo8 AS Modulo,\n        CASILLERO8 AS CASILLERO, CASILLEROB8 AS CASILLEROB,\n        Corte1_8 AS Corte1, Corte2_8 AS Corte2, Corte1b_8 AS Corte1b, Corte2b_8 AS Corte2b,\n        ID8 AS ID, KTN8 AS KTN, MAQ8 AS MAQ, MAQ2_8 AS MAQ2, REF8 AS REF,\n        Lin8 AS Lin, Sit8 AS Sit, Rec8 AS Rec, UD8 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med8 IS NOT NULL AND Med8 > 0\n    \n    UNION ALL\n    \n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo,\n        -- Descomponer ítem 9\n        Med9 AS Med, MedH9 AS MedH, Modulo9 AS Modulo,\n        CASILLERO9 AS CASILLERO, CASILLEROB9 AS CASILLEROB,\n        Corte1_9 AS Corte1, Corte2_9 AS Corte2, Corte1b_9 AS Corte1b, Corte2b_9 AS Corte2b,\n        ID9 AS ID, KTN9 AS KTN, MAQ9 AS MAQ, MAQ2_9 AS MAQ2, REF9 AS REF,\n        Lin9 AS Lin, Sit9 AS Sit, Rec9 AS Rec, UD9 AS UD,\n        Grafico, Parametros\n    FROM fpresupuestosoptimizacion\n    WHERE CodigoSerie = p_Serie AND CodigoNumero = p_Numero AND CodigoPerfil = p_CodigoArticulo\n      AND CodigoAcabado = p_CodigoAcabado \n      AND ((CodigoAcabado2 = p_CodigoAcabado2) OR ((CodigoAcabado2 IS NULL) AND (p_CodigoAcabado2 = \'\')))\n      AND Med9 IS NOT NULL AND Med9 > 0;\n\n    -- PASO 2: Crear tabla reagrupada por módulo y medidas\n    DROP TEMPORARY TABLE IF EXISTS temp_items_reagrupados;\n    CREATE TEMPORARY TABLE temp_items_reagrupados AS\n    SELECT \n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        Ancho, Maquina, Tipo, Modulo, Med,\n        -- Mantener información del primer ítem del grupo (pero con valores reales)\n        MedH, CASILLERO, CASILLEROB,\n        Corte1, Corte2, Corte1b, Corte2b,\n        ID, KTN, MAQ, MAQ2, REF,\n        Lin, Sit, Rec, UD,\n        Grafico, Parametros,\n        COUNT(*) AS cantidad_items_reagrupados\n    FROM temp_items_descompuestos\n    GROUP BY CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n             Ancho, Maquina, Tipo, Modulo, Med,\n             MedH, CASILLERO, CASILLEROB, Corte1, Corte2, Corte1b, Corte2b,\n             ID, KTN, MAQ, MAQ2, REF, Lin, Sit, Rec, UD, Grafico, Parametros\n    ORDER BY Med DESC, Modulo;\n\n    -- PASO 3: Aplicar optimización con ordenamiento item a item\n    DROP TEMPORARY TABLE IF EXISTS temp_items_expandidos;\n    CREATE TEMPORARY TABLE temp_items_expandidos AS\n    SELECT \n        r.*,\n        numeros.n AS item_repeticion,\n        @row_number := @row_number + 1 AS item_orden\n    FROM temp_items_reagrupados r\n    INNER JOIN (\n        SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5\n        UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10\n        UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15\n        UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20\n    ) numeros ON numeros.n <= r.cantidad_items_reagrupados\n    CROSS JOIN (SELECT @row_number := 0) AS init\n    ORDER BY r.Med DESC, r.Modulo, numeros.n;\n\n    -- PASO 4: Aplicar lógica de optimización de barras\n    SELECT \n        -- Campos básicos\n        CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2,\n        barra_asignada AS Barra,\n        1 AS Corte,\n        COUNT(*) AS Medidas,\n        COUNT(*) AS Asignadas,\n        0 AS AsignadasB,\n        1 AS Cantidad,\n        0 AS BarraMaq,\n        SUM(Med) AS Longitud,\n        MAX(Ancho) AS Ancho,\n        MAX(Maquina) AS Maquina,\n        MAX(Tipo) AS Tipo,\n        \n        -- Med0-Med9 (hasta 10 ítems por barra)\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Med END), 0) AS Med0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Med END), 0) AS Med1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Med END), 0) AS Med2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Med END), 0) AS Med3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Med END), 0) AS Med4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Med END), 0) AS Med5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Med END), 0) AS Med6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Med END), 0) AS Med7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Med END), 0) AS Med8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Med END), 0) AS Med9,\n        \n        -- MedH0-MedH9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN MedH END), 0) AS MedH0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN MedH END), 0) AS MedH1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN MedH END), 0) AS MedH2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN MedH END), 0) AS MedH3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN MedH END), 0) AS MedH4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN MedH END), 0) AS MedH5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN MedH END), 0) AS MedH6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN MedH END), 0) AS MedH7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN MedH END), 0) AS MedH8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN MedH END), 0) AS MedH9,\n        \n        -- Modulo0-Modulo9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Modulo END), \'\') AS Modulo0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Modulo END), \'\') AS Modulo1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Modulo END), \'\') AS Modulo2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Modulo END), \'\') AS Modulo3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Modulo END), \'\') AS Modulo4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Modulo END), \'\') AS Modulo5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Modulo END), \'\') AS Modulo6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Modulo END), \'\') AS Modulo7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Modulo END), \'\') AS Modulo8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Modulo END), \'\') AS Modulo9,\n        \n        -- CASILLERO0-CASILLERO9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN CASILLERO END), 0) AS CASILLERO0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN CASILLERO END), 0) AS CASILLERO1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN CASILLERO END), 0) AS CASILLERO2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN CASILLERO END), 0) AS CASILLERO3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN CASILLERO END), 0) AS CASILLERO4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN CASILLERO END), 0) AS CASILLERO5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN CASILLERO END), 0) AS CASILLERO6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN CASILLERO END), 0) AS CASILLERO7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN CASILLERO END), 0) AS CASILLERO8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN CASILLERO END), 0) AS CASILLERO9,\n        \n        -- CASILLEROB0-CASILLEROB9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN CASILLEROB END), 0) AS CASILLEROB0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN CASILLEROB END), 0) AS CASILLEROB1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN CASILLEROB END), 0) AS CASILLEROB2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN CASILLEROB END), 0) AS CASILLEROB3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN CASILLEROB END), 0) AS CASILLEROB4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN CASILLEROB END), 0) AS CASILLEROB5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN CASILLEROB END), 0) AS CASILLEROB6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN CASILLEROB END), 0) AS CASILLEROB7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN CASILLEROB END), 0) AS CASILLEROB8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN CASILLEROB END), 0) AS CASILLEROB9,\n        \n        -- Corte1_0-Corte1_9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Corte1 END), 0) AS Corte1_0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Corte1 END), 0) AS Corte1_1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Corte1 END), 0) AS Corte1_2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Corte1 END), 0) AS Corte1_3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Corte1 END), 0) AS Corte1_4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Corte1 END), 0) AS Corte1_5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Corte1 END), 0) AS Corte1_6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Corte1 END), 0) AS Corte1_7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Corte1 END), 0) AS Corte1_8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Corte1 END), 0) AS Corte1_9,\n        \n        -- Corte2_0-Corte2_9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Corte2 END), 0) AS Corte2_0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Corte2 END), 0) AS Corte2_1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Corte2 END), 0) AS Corte2_2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Corte2 END), 0) AS Corte2_3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Corte2 END), 0) AS Corte2_4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Corte2 END), 0) AS Corte2_5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Corte2 END), 0) AS Corte2_6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Corte2 END), 0) AS Corte2_7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Corte2 END), 0) AS Corte2_8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Corte2 END), 0) AS Corte2_9,\n        \n        -- Corte1b_0-Corte1b_9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Corte1b END), 0) AS Corte1b_0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Corte1b END), 0) AS Corte1b_1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Corte1b END), 0) AS Corte1b_2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Corte1b END), 0) AS Corte1b_3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Corte1b END), 0) AS Corte1b_4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Corte1b END), 0) AS Corte1b_5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Corte1b END), 0) AS Corte1b_6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Corte1b END), 0) AS Corte1b_7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Corte1b END), 0) AS Corte1b_8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Corte1b END), 0) AS Corte1b_9,\n        \n        -- Corte2b_0-Corte2b_9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Corte2b END), 0) AS Corte2b_0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Corte2b END), 0) AS Corte2b_1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Corte2b END), 0) AS Corte2b_2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Corte2b END), 0) AS Corte2b_3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Corte2b END), 0) AS Corte2b_4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Corte2b END), 0) AS Corte2b_5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Corte2b END), 0) AS Corte2b_6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Corte2b END), 0) AS Corte2b_7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Corte2b END), 0) AS Corte2b_8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Corte2b END), 0) AS Corte2b_9,\n        \n        -- ID0-ID9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN ID END), 0) AS ID0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN ID END), 0) AS ID1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN ID END), 0) AS ID2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN ID END), 0) AS ID3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN ID END), 0) AS ID4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN ID END), 0) AS ID5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN ID END), 0) AS ID6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN ID END), 0) AS ID7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN ID END), 0) AS ID8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN ID END), 0) AS ID9,\n        \n        -- KTN0-KTN9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN KTN END), 0) AS KTN0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN KTN END), 0) AS KTN1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN KTN END), 0) AS KTN2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN KTN END), 0) AS KTN3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN KTN END), 0) AS KTN4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN KTN END), 0) AS KTN5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN KTN END), 0) AS KTN6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN KTN END), 0) AS KTN7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN KTN END), 0) AS KTN8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN KTN END), 0) AS KTN9,\n        \n        -- MAQ0-MAQ9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN MAQ END), 0) AS MAQ0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN MAQ END), 0) AS MAQ1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN MAQ END), 0) AS MAQ2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN MAQ END), 0) AS MAQ3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN MAQ END), 0) AS MAQ4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN MAQ END), 0) AS MAQ5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN MAQ END), 0) AS MAQ6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN MAQ END), 0) AS MAQ7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN MAQ END), 0) AS MAQ8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN MAQ END), 0) AS MAQ9,\n        \n        -- MAQ2_0-MAQ2_9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN MAQ2 END), 0) AS MAQ2_0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN MAQ2 END), 0) AS MAQ2_1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN MAQ2 END), 0) AS MAQ2_2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN MAQ2 END), 0) AS MAQ2_3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN MAQ2 END), 0) AS MAQ2_4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN MAQ2 END), 0) AS MAQ2_5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN MAQ2 END), 0) AS MAQ2_6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN MAQ2 END), 0) AS MAQ2_7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN MAQ2 END), 0) AS MAQ2_8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN MAQ2 END), 0) AS MAQ2_9,\n        \n        -- REF0-REF9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN REF END), 0) AS REF0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN REF END), 0) AS REF1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN REF END), 0) AS REF2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN REF END), 0) AS REF3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN REF END), 0) AS REF4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN REF END), 0) AS REF5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN REF END), 0) AS REF6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN REF END), 0) AS REF7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN REF END), 0) AS REF8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN REF END), 0) AS REF9,\n        \n        -- Lin0-Lin9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Lin END), 0) AS Lin0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Lin END), 0) AS Lin1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Lin END), 0) AS Lin2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Lin END), 0) AS Lin3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Lin END), 0) AS Lin4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Lin END), 0) AS Lin5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Lin END), 0) AS Lin6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Lin END), 0) AS Lin7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Lin END), 0) AS Lin8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Lin END), 0) AS Lin9,\n        \n        -- Sit0-Sit9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Sit END), 0) AS Sit0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Sit END), 0) AS Sit1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Sit END), 0) AS Sit2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Sit END), 0) AS Sit3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Sit END), 0) AS Sit4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Sit END), 0) AS Sit5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Sit END), 0) AS Sit6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Sit END), 0) AS Sit7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Sit END), 0) AS Sit8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Sit END), 0) AS Sit9,\n        \n        -- Rec0-Rec9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN Rec END), 0) AS Rec0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN Rec END), 0) AS Rec1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN Rec END), 0) AS Rec2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN Rec END), 0) AS Rec3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN Rec END), 0) AS Rec4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN Rec END), 0) AS Rec5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN Rec END), 0) AS Rec6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN Rec END), 0) AS Rec7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN Rec END), 0) AS Rec8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN Rec END), 0) AS Rec9,\n        \n        -- UD0-UD9\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 1 THEN UD END), 0) AS UD0,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 2 THEN UD END), 0) AS UD1,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 3 THEN UD END), 0) AS UD2,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 4 THEN UD END), 0) AS UD3,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 5 THEN UD END), 0) AS UD4,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 6 THEN UD END), 0) AS UD5,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 7 THEN UD END), 0) AS UD6,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 8 THEN UD END), 0) AS UD7,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 9 THEN UD END), 0) AS UD8,\n        COALESCE(MAX(CASE WHEN posicion_en_barra = 10 THEN UD END), 0) AS UD9,\n        \n        -- Campos finales\n        MAX(Grafico) AS Grafico,\n        MAX(Parametros) AS Parametros\n        \n    FROM (\n        SELECT \n            *,\n            @barra_actual := CASE \n                WHEN @longitud_acumulada + Med <= Ancho AND @items_en_barra < 10\n                THEN @barra_actual\n                ELSE @barra_actual + 1\n            END AS barra_asignada,\n            \n            @items_en_barra := CASE\n                WHEN @barra_actual <> @barra_anterior\n                THEN 1\n                ELSE @items_en_barra + 1\n            END AS posicion_en_barra,\n            \n            @longitud_acumulada := CASE\n                WHEN @barra_actual <> @barra_anterior\n                THEN Med\n                ELSE @longitud_acumulada + Med\n            END AS longitud_actual,\n            \n            @barra_anterior := @barra_actual AS barra_anterior_track\n            \n        FROM temp_items_expandidos\n        ORDER BY item_orden\n    ) items_optimizados\n    WHERE barra_asignada IS NOT NULL\n    GROUP BY CodigoSerie, CodigoNumero, CodigoPerfil, CodigoAcabado, CodigoAcabado2, barra_asignada\n    ORDER BY CodigoPerfil, CodigoAcabado, CodigoAcabado2, barra_asignada;\n    \n    -- Limpiar tablas temporales\n    DROP TEMPORARY TABLE IF EXISTS temp_items_descompuestos;\n    DROP TEMPORARY TABLE IF EXISTS temp_items_reagrupados;\n    DROP TEMPORARY TABLE IF EXISTS temp_items_expandidos;\n\nEND', 'utf8mb4', 'utf8mb4_general_ci', 'latin1_swedish_ci'
